# -*- coding: utf-8 -*-
import urllib2
import re
import datetime

def remove_completed_tasks():
    completedTasks = db(db.scheduler_task.status=="COMPLETED").delete()
    db.commit()

def emergency_email(email, ticker, label, limit):
    mail = auth.settings.mailer
    mail.settings.server = 'smtp.gmail.com:587'
    mail.settings.sender = 'ucscstock@gmail.com'
    mail.settings.login = 'ucscstock@gmail.com:julligjullig'
    title = 'Slug Stock: STOCK UPDATE FOR ' + ticker
    body = ticker + '\'s price has ' + label + ' the price limit you set of ' + str(limit)
    mail.send(email, title , body)

def updateYahooPrices():
    currentPrices = db(db.current.ticker!=None).select()
    for currPrice in currentPrices:
        htmlfile = urllib2.urlopen("http://finance.yahoo.com/q?s="+currPrice.ticker)
        htmltext = htmlfile.read()
        regex = '<span id="yfs_l84_'+currPrice.ticker+'">(.+?)</span>'
        pattern = re.compile(regex)
        newPrice = re.findall(pattern,htmltext)
        db.recent.insert(ticker=currPrice.ticker,
                         price=float(newPrice[0]),
                         day=db(db.day.day!=None).select().first().day,
                         datetime=datetime.datetime.today())
        try:
            subscriptions = db(db.subscription.ticker==currPrice.ticker).select()
            for currSub in subscriptions:
                email = db(db.auth_user.id==currSub.u_id).select().first().email
                if currPrice.price < currSub.value and currSub.value < float(newPrice[0]):
                    scheduler.queue_task('emergency_email', [email, currSub.ticker, 'risen above', currSub.value])
                    db(db.subscription.id==currSub.id).delete()
                elif currPrice.price > currSub.value and currSub.value > float(newPrice[0]):
                    scheduler.queue_task('emergency_email', [email, currSub.ticker, 'fallen below', currSub.value])
                    db(db.subscription.id==currSub.id).delete()
            currPrice.update_record(price=float(newPrice[0]))
            db.commit()
        except IndexError as e:
            i = 1#do nothing

def email_trevor():
    mail = auth.settings.mailer
    mail.settings.server = 'smtp.gmail.com:587'
    mail.settings.sender = 'ucscstock@gmail.com'
    mail.settings.login = 'ucscstock@gmail.com:julligjullig'
    mail.send('twbarne@ucsc.edu', 'Message subject', 'Plain text body of the message')


def email_daily():
    users = db(db.auth_user).select()
    for user in users:
        following = db(db.following.u_id==user.id).select()
        follow_list = []
        if following:
            for stock in following:
                current = db(db.current.ticker == stock.ticker).select().first()
                follow_list.append((current.ticker, current.price))
            follow_string = "Hello, " + user.first_name + ". Here are the closing prices of the stocks you are currently following: \n"
            for x in follow_list:
                follow_string += "Ticker: " + x[0] + " Closing Price: " + str(x[1]) + "\n"
            mail = auth.settings.mailer
            mail.settings.server = 'smtp.gmail.com:587'
            mail.settings.sender = 'ucscstock@gmail.com'
            mail.settings.login = 'ucscstock@gmail.com:julligjullig'
            mail.send(to=user.email,
                      subject='Your Daily Stock Information Courtesy of SlugStock',
                      message=(follow_string))

def nextday():
    day = db(db.day.day!=None).select().first()
    day.update_record(day=day.day)
    db.commit()

from gluon.scheduler import Scheduler
scheduler = Scheduler(db, heartbeat=60, tasks=dict(email=email_daily, updatePrices=updateYahooPrices, emergency_email=emergency_email, clear=remove_completed_tasks, nextday=nextday))
